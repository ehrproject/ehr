<!DOCTYPE html>
<html>
<head>
	<style>



	.nav {
		background-color:rgba(0,0,0,0.2) !important;
		border-color: transparent !important;
		background-image:none !important;
		color:white !important;
	}
	.nav .btn {
		background-color: rgba(255, 255, 255, 0) !important;
		color: rgb(255, 255, 255);
		border-color: rgba(255, 255, 255, 0.205)!important;
	}
	.nav li{
		padding-left:30px;
		padding-right:20px;
	}
	.nav a{
		color:white !important;
	}
	.nav input{
		background-color: rgba(255, 255, 255, 0.171);
		border-color: transparent !important;
	}
	.nav ::placeholder {
		color:white !important;
	}



	.sticky {
		position: -webkit-sticky;
		position: sticky;
		top: 0;
	}

	.sticky:before,
	.sticky:after {
		content: '';
		display: table;
	}
	.sidebarContainer {
	}
	.sidebar {
		fill: solid;
		background: #24345E;
		color: white;
		padding-right: 0px !important;
	}
	.basicInfo {
		padding-left: 30px;
		padding-right: 40px;
		padding-top: 66px;
		padding-bottom: 30%; 
	}
	.basicInfo p {
		margin-bottom: 10px;
		line-height: 100%;
	}
	.active {
	}
	.links {
		display: block !important;
	}
	.header {
		display: inline-block;
	}
	.hdrBtns {
		display: inline-block;
		float:right;  }
		.Rplus {
			font-size: 48px;
		}
		.background {
			background-color: #E1EBF2
		}
		.box {
			margin-left: 10px;
			margin-right: 20px;
			margin-top: 10px;
			margin-bottom: 10px;
			padding: 15px;
		}
		.summary {
			font-size: 48px;
		}
		.topRight {
			position: absolute;
			top: 5px;
			right:10px;
		}
		.med {
			margin: 10px !important;
			margin-bottom: 25px !important;
		}


		.add {
			float: right;
			width: 5%;
		}

		.formSubmit {
			float: right;
			margin-top: 20px;
			margin-right: 2.3%;
		}
		.current {
			padding-top: 10px;
			padding-bottom: 10px;
			border-bottom-style: solid;
			border-bottom-width: 1px;
			margin-bottom: 10px;
		}
		.links {
			background-color: #3D5982;
		}


	</style>
	<title>Patient Page</title>


	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
	integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>

	<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Pacifico"/>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
	integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
	crossorigin="anonymous"></script>
	<script type="text/javascript" src="/files/js/stickyfillmin.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>


</head>
<body style="background-color: #E1EBF2;"> 
	<div class="background">
		<div class="sidebarContainer">
			<div class="row">
				<nav class="col-sm-2 sidebar">
					<div class = "sidebar sticky " >
						<div class = "basicInfo"> 
							<h2 id = "name">  </h2>
							<br>
							<p id="ageSex"></p>
							<p id="dob"></p>
							<p id="heightWeight"></p>
							<br>
							<p id="allergiesSide"></p>

						</div>
						<div class="links">
							<ul class="nav nav-pills nav-stacked links">
								<li class="active current">
									<a href="allergies">Allergies</a></li>
									<li><a href="patientPage">Patient Summary</a></li>
									<li><a href="#section2">Social History</a></li>
									<li><a href="problemList">Problem List</a></li>
									<li><a href="#section4">Immunization Record</a></li>
									<li><a href="#section3">Well Child Check</a></li>
									<li><a href="#section5">Testing</a></li>
									<li><a href="#section6">Growth Charts</a></li>
									<li><a href="#section7">Nurse Notes</a></li>
									<li><a href="#section8">Scans</a></li>
								</li>

							</ul>
						</div>
					</div>
				</nav>
				<div class="col-lg">   

					<div class = "card header">
						<div class = "topRight">
							<p> Welcome, "User Name"  | </p>
							<button> Logout </button>
						</div>

						<div class = "Rplus header"> R+ Childrens </div>

						<div class = "hdrBtns header">
							<a href="#Pharmacy">Pharmacy</a>
							<a href="#AllPatients">All Patients</a>
							<a href="#AddPatient">Add Patient</a>
						</div>

					</div>


					<div class = "card box summary"> 
						<h3> Allergies </h3>

					</div>

					<div id = "allergies" class="card med">
						<div>
							<div class="card-header">
								<h3> </h3>
								<div class="row">
									<div class="col-sm"> Allergen </div>
									<div class="col-sm"> Type of Reaction </div>
									<div class="col-sm"> Severity </div>
									<div class="col-sm"> Onset of Reaction </div>
									<div class="col-sm"> Notes </div>

								</div>
							</div>
						</div>
						<div id="allergyContainer"> </div>

						<div id = "formContainer" class="box addField">
							<form id="allergyForm" method="post">
								<div>
									<div class="row">
										<div class="col-sm">
											<input type="text" name="allergyType" placeholder="Allergen"></div> 
											<div class="col-sm"><input type="text" name="allergySymptoms" placeholder="Type of Reaction"></div> 
											<div class="col-sm"><input type="text" name="allergySeverity" placeholder="Severity"></div>
											<div class="col-sm"><input type="text" name="onset" placeholder="Onset"></div> 
											<div class="col-sm "><input type="text" name="notes" placeholder="Notes"></div>
										</div> 
										<div >
											<input type="submit" value="Submit" id="submitAllergy" class="formSubmit"> </div>
										</form>
									</div>
									<button id="addAllergy" class="add"> + </button>
								</div>
							</div>



							<div id = "chronicProb" class="card med">
								<div class="card-header">
									<h3> Other card? </h3>
									<div class="row">
										<div class="col-sm"> Diagnosis </div>
										<div class="col-sm"> Treatment </div>
										<div class="col-sm"> Dose </div>
										<div class="col-sm"> Time </div>
										<div class="col-sm"> Route </div>
										<div class="col-sm"> Date of Onset </div>
										<div class="col-sm"> Date of Resolution </div>
										<div class="col-sm"> Duration </div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>

		</body>


		<script>


			$(document).ready(function(){

				// Make sidebar sticky
				var elements = document.querySelectorAll('.sticky');
				Stickyfill.add(elements);

            // Initial Page Load
            $.ajax({
            	type: 'POST',
            	url: '/getPatientKeys',
            	data: {
            		search: '',
            		field: 'lastName',
            	},
            	success: function(result) {
            		patients = result.patient;
            		getPatientData(result.patient);
            	}
            });


            $('#allergyForm').hide();
            // Respond to submission of allergy form
            $('#allergyForm').on('submit', function(event) {
            	event.preventDefault();
            	console.log("on submit");
            	var data = $('#allergyForm').serialize();

            	$.ajax({
            		type: 'POST',
            		url: '/addAllergy',
            		data: data,
            		success: function (result) {
            			$('#allergyForm')[0].reset();

            			$('#allergyForm').hide();
            			$('#addAllergy').show();
            			updateAllergyCard(result);
            			console.log(result);
            		},
            		error: function(XMLHttpRequest, textStatus, errorThrown) {
            			console.error("error: " + errorThrown);
            		}
            	});

            });


            // Show and hide buttons on click
            $('#addAllergy').click(function() {
            	$('#addAllergy').hide();
            	$('#allergyForm').show();

            });

        });
// Updates allergy card after form submission
var updateAllergyCard = function(allergies) { 
				// dummy variable for temporary data
				var allergies = [{allergen: 'peanut', severity: 'mild', reaction: 'throat closure', onsent: '12-08-2009', notes: 'avoid tree nuts in general, especially almonds'}];

				$('#allergyContainer').empty();
				for (i = 0; i < allergies.length; i++) {
					var allergiesCard = '<div class="box">' +
					'<div class="row"><div class="col-sm">' + allergies[0].allergen + 
					'</div><div class="col-sm">' + allergies[0].reaction +
					'</div> <div class="col-sm">' + allergies[0].severity + 
					'</div> <div class="col-sm">' + allergies[0].onsent +
					'</div> <div class="col-sm ">' + allergies[0].notes +
					'</div></div>' ;
					$('#allergyContainer').append(allergiesCard);
				}
			}


// Displays the patient's data on page
var getPatientData = function(patient) {
	var temp = patient;
				// temporary data
				var allergies = [{allergen: 'peanut', severity: 'mild', reaction: 'throat closure', onsent: '12-08-2009', notes: 'avoid tree nuts in general, especially almonds'}];
				console.log('here:' + patient);

				var cards = "";
				var date = new Date(2018,2,12);
				var i = 1;
				var patient = patient[i];

				// Update sidebar content
				$('#name').text(patient.firstName + ' ' + patient.lastName);
 	$('#ageSex').text(getAge(patient.birthdate) + ', ' + 'F' ); //paitient.sex
 	$('#dob').text(patient.birthdate);
 	$('#heightWeight').text(patient.height + " cm, " + patient.weight + " kgs");
 	$('#allergiesSide').text('Allergies: ' + allergies[0].allergen );


// Update allergies content
var allergiesCard = '<div class="box">' +
'<div class="row"><div class="col-sm">' + allergies[0].allergen + 
'</div><div class="col-sm">' + allergies[0].reaction +
'</div> <div class="col-sm">' + allergies[0].severity + 
'</div> <div class="col-sm">' + allergies[0].onsent +
'</div> <div class="col-sm ">' + allergies[0].notes +
'</div></div>' ;



$('#allergyContainer').append(allergiesCard);

}

 	 				// Calculates age of patient in years, months, weeks, and days
 	 				function getAge(fromdate, todate){
 	 					if(todate) todate= new Date(todate);
 	 					else todate= new Date();

 	 					var age= [], fromdate= new Date(fromdate),
 	 					y= [todate.getFullYear(), fromdate.getFullYear()],
 	 					ydiff= y[0]-y[1],
 	 					m= [todate.getMonth() + 1, fromdate.getMonth()],
 	 					mdiff= m[0]-m[1],
 	 					d= [todate.getDate(), fromdate.getDate()],
 	 					ddiff= d[0]-d[1];

 	 					if(mdiff < 0 || (mdiff=== 0 && ddiff<0))--ydiff;
 	 					if(mdiff<0) mdiff+= 12;
 	 					if(ddiff<0){
 	 						fromdate.setMonth(m[1]+1, 0);
 	 						ddiff= fromdate.getDate()-d[1]+d[0];
 	 						--mdiff;
 	 					}
 	 					w = Math.floor(ddiff/7);
 	 					ddiff = ddiff % 7;
                  // 3 or older -> show year
                  if (ydiff > 2) age.push(ydiff+ ' year'+(ydiff> 1? 's ':' '));
                  else if (ydiff> 0) {
                    // Over a year -> show year and month
                    age.push(ydiff+ ' year'+(ydiff> 1? 's ':' '));
                    if(mdiff> 0) age.push(mdiff+ ' month'+(mdiff> 1? 's':''));
                    // Less than a year -> show month and day
                } else if (mdiff> 3) {
                	age.push(mdiff+ ' month'+(mdiff> 1? 's':''));
                	if (w> 0) age.push(w+ ' week' + (w> 1? 's':''));
                } else if (mdiff>0) {
                	age.push(mdiff+ ' month'+(mdiff> 1? 's ':' '));
                	if(w> 0) age.push(w+ ' week'+(w> 1? 's':''));
                } else {
                	if(w> 0) age.push(w+ ' week'+(w> 1? 's':''));
                	if(ddiff> 0) age.push(ddiff+ ' day'+(ddiff> 1? 's':''));
                }

                if(age.length>1) age.splice(age.length-1,0,' and ');    
                return age.join('');
            }








        </script>
    </body>
    </html>

